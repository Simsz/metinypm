# Global options
admin off
http_port 80
https_port 443

log {
    output stdout
    format console
    level INFO
}

# Enable on-demand TLS with more detailed configuration
on_demand_tls {
    ask http://192.99.245.232:3131/api/domains/verify
    interval 2m
    burst 5
}

# Global TLS configuration
email privacy@tiny.pm

(is_custom_domain) {
    # Update to include origin.tiny.pm in the exclusion list
    not host tiny.pm origin.tiny.pm *.tiny.pm zachsims.com splits.zachsims.com getrekt.cc *.getrekt.cc localhost
}

# Main host block that handles tiny.pm and origin.tiny.pm
tiny.pm, origin.tiny.pm {
    # Your existing configuration
    reverse_proxy localhost:3000
}

# Handle all other domains that might point to your server
:443 {
    # This block handles all HTTPS requests for other domains
    tls {
        # Enable on-demand TLS for custom domains
        on_demand
    }
    
    reverse_proxy localhost:3000
}

# Configuration for direct access (non-Cloudflare users)
https://origin.tiny.pm {
	reverse_proxy 192.99.245.232:3131 {
		header_up Host {host}
		header_up X-Real-IP {remote_host}
	}
}

# Handle custom domains
:443 {
	tls {
		on_demand
	}
	
	reverse_proxy 192.99.245.232:3131 {
		header_up Host {host}
		header_up X-Real-IP {remote_host}
	}
}

# Primary application
https://tiny.pm {
	reverse_proxy 192.99.245.232:3131 {
		header_up Host {host}
		header_up X-Real-IP {remote_host}
	}
}

# Direct access endpoint (for Cloudflare users)
https://origin.tiny.pm {
	reverse_proxy 192.99.245.232:3131 {
		header_up Host tiny.pm
		header_up X-Real-IP {remote_host}
	}
}

https://cs.tiny.pm {
	handle_path /api/* {
		reverse_proxy g5api:3301
	}

	handle * {
		reverse_proxy g5v:80
	}
} 